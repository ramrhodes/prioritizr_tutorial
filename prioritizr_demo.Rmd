---
title: "EcoDataScience Workshop: Conservation Planning with Prioritizr"
author: "Anna Abelman, Vanessa Rathbone, & Rachel Rhodes"
date: "5/7/2021"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: false
    theme: cerulean
    highlight: haddock
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### Load packages
library(raster)
library(tidyverse)
library(sf)
library(here)
library(fasterize)
library(stringr)
library(janitor)
library(prioritizr)
library(rgdal)
library(gurobi)
```

# Session summary
For this EcoDataScience session, we will cover some basics of working with  `prioritizr` R package to build and solve conservation planning problems using marine spatial data presented in gridded format (rasters) and vector format (line, point, polygons). We will go through the basic functionality and necessary inputs to create and solve a conservation planning problem, as well as some guidance on how you can custom-tailor this to the specific needs of different conservation planning exercises. For brevity, we will not go through all the pre-processing steps of cleaning up the raw spatial data we used for this analysis, but will include a separate set-up RMD that outlines what we did which you are welcome to check out on your own. 

The analysis presented in this tutorial comes from a USCB Bren School of Environmental Science & Management master's project by Anna Abelman, Courtney Krone, Vanessa Rathbone, Rachel Rhodes & Erin Ristig in collaboration with Wildlife Conservation Society. The project aimed to identify priority areas to protect sharks and rays in Mozambique. For more information on the project you can visit: https://bren.ucsb.edu/projects/framework-designing-marine-protected-areas-sharks-and-rays-mozambique

# Background
## What is Prioritizr?
The *prioritizr* R package is a systematic conservation planning tool that is used to design an optimal system of protected areas that meet conservation objectives using ecological, social, and economic criteria. Specifically, this tool is used to conduct spatial prioritization that finds the efficient spatial allocation of priority areas by formulating a mathematical optimization problem and then solving it to find an efficient solution. This type of tool is useful for conservation planning because it can help inform decisions on how and where to focus conservation efforts given limited resources and can make for a more transparent and reproducible decision making process. 

For those of you familiar with other conservation planning software like Marxan,  *prioritizr* is similar, however, instead of using simulated annealing, *prioritizr* uses integer linear programming (ILP) and an algorithm solver to find the exact optimal solution and can help find cheaper solutions in a shorter period of time. It requires similar inputs which are described below. 

## Necessary Inputs
The following parameters are required to conduct and solve a conservation planning exercise with *prioritizr*: 

1. Study Area: define area of interest

2. Planning Units: divide the study area into set of discrete areas called planning units

3. Cost: specifies the cost of including/managing each planning unit in the reserve system.  This value can be a measure of the actual fiscal cost required to purchase a piece of land or it can be a surrogate for cost that represents management costs or opportunity costs of foregone activities. 

4. Conservation Features: biodiversity elements that are of conservation interest - often include species, populations, or habitats 

5. Problem objective: defines the overall goal of the conservation plan & whether a specific property of the solution should be maximized or minimized (there are a number of different types of objectives that can be used which are described more later)

## Example data
**Mozambique Exclusive Economic Zone (EEZ):** 

**Species Data:** IUCN 2021. The IUCN Red List of Threatened Species. Version 2021-1. <https://www.iucnredlist.org>

**Habitat:** 
Coral & Seagrass: Allen Coral Atlas maps, bathymetry and map statistics are © 2018-2021 Allen Coral Atlas Partnership and Vulcan, Inc. and licensed CC BY 4.0 (https://creativecommons.org/licenses/by/4.0/)

Mangroves: Giri C, Ochieng E, Tieszen LL, Zhu Z, Singh A, Loveland T, Masek J, Duke N (2011). Status and distribution of mangrove forests of the world using earth observation satellite data (version 1.4, updated by UNEP-WCMC). Global Ecology and Biogeography 20: 154-159. Data DOI: https://doi.org/10.34892/1411-w728 

Seamount & Knolls: Yesson C, Clark MR, Taylor M, Rogers AD (2011). The global 
distribution of seamounts based on 30-second bathymetry data. Deep Sea Research Part I: Oceanographic Research Papers 58: 442-453. DOI: http://dx.doi.org/10.1016/j.dsr.2011.02.004. Data DOI: http://doi.pangaea.de/10.1594/PANGAEA.757564


**Fishing Pressure:** 
Global Fishing Watch
D.A. Kroodsma, J. Mayorga, T. Hochberg, N.A. Miller, K. Boerder, F. Ferretti, A. Wilson, B. Bergman, T.D. White, B.A. Block, P. Woods, B. Sullivan, C. Costello, and B. Worm. "Tracking the global footprint of fisheries." Science 361.6378 (2018).

# Basic Analysis

## Step 1. Project Area & Planning  Units
The first step is to define the project area - for this analysis we will use the Mozambique Exclusive Economic Zone, and divide the area up into planning units. 

The size of the planning unit can impact the outcomes of the reserve design, so it is
important to carefully consider the spatial scale of the planning unit - for this exercise we will rasterize the project area to produce a grid of cells at 10km^2 resolution. 

```{r}
## Grab Mozambique's EEZ shapefile
mz_eez_sf <- sf::read_sf(here("data", "mz_eez"))

## check coordinate system
st_crs(mz_eez_sf)

## Use Moz EEZ to set extent for future rasters
mz_ext <- raster::extent(mz_eez_sf)

## To create planning units, create raster with cell ids with a resolution of 10,000 km and clip to MZ EEZ raster
mz_eez_rast <- raster::raster(x=mz_ext, crs=crs(mz_eez_sf), res=10000)

## Assign cell values
values(mz_eez_rast) <- 1:ncell(mz_eez_rast) 

## Create data frame to check it out
mz_eez_rast_df <- rasterToPoints(mz_eez_rast) %>%
  as.data.frame()

## Plot to make sure it looks good
plot(mz_eez_rast)

## Mask it to only include the EEZ
mz_eez_rast <- mask(mz_eez_rast, mz_eez_sf)
plot(mz_eez_rast)

## Store as object called pu for planning unit
mz_pu <- mz_eez_rast
```


## Step 2. Conservation Features 
For this exercise we will use spatial data of species distribution from IUCN and five critical habitats that are important for sharks and rays. For brevity, we will load in the species and critical habitat spatial data that has already been pre-processed (rasterized & projected in the same coordinate system) - if you would like to see how we did this you can check out the `set-up.RMD`. 

```{r}
## Pull in species & habitat rasters from 'cleaned_data' folder
devil_ray_rast <- raster(here("cleaned_data", "devil_ray.tif"))
sawfish_rast <- raster(here("cleaned_data", "sawfish.tif"))
reef_manta_rast <- raster(here("cleaned_data", "reef_manta.tif"))
scalloped_hammerhead_rast <- raster(here("cleaned_data", "scalloped_hammerhead.tif"))
dusky_shark_rast <- raster(here("cleaned_data", "dusky_shark.tif"))
knolls_habitat <- raster(here("cleaned_data", "knolls.tif"))
seamounts_habitat <- raster(here("cleaned_data", "seamounts.tif"))

## Create a raster stack of all the conservation features
feature_stack <- stack(devil_ray_rast, sawfish_rast, reef_manta_rast, scalloped_hammerhead_rast, dusky_shark_rast, knolls_habitat, seamounts_habitat)

## Plot to see what it looks like
plot(feature_stack)
```


## Step 3. Cost
We will use fishing pressure as a surrogate for cost in our model which represents the cost of lost fishing opportunity. This will prioritize areas with the least fishing activity that overlap with areas that are critical for sharks and rays - this will show us the reserve designs that have the least impact on fishers (alternatively you could create an inverse of this cost layer to prioritize areas with the most fishing activity that overlap with critical areas for sharks and rays which would have the most benefit for sharks and rays, but greater impacts on fishers).

```{r}
## Pull in the fishing pressure data from the 'cleaned_data' folder
fishing_cost <- raster(here("cleaned_data", "fishing_stack.tif"))

## Plot to see what it looks like
plot(fishing_cost)

fishing_cost_df <- as.data.frame(fishing_cost)

```


## Step 4. Create conservation problem
Now that we have these three basic inputs, it is time to start constructing our conservation problem. 

There are a few key considerations that go into this including: 
(1) what type of problem objective we want to use 
(2) what are the conservation targets (minimum proportion  of each conservation feature that need to be included int he reserve system)?

The problem objective defines the overall goal of the conservation plan. This can be done a number of ways including using a minimum set objective which minimizes the cost of a reserve network, while ensuring all targets are met; maximum features objective, which fulfills as many targets as possible within a specific budget; maximum phylogenetic diversity objective which maximizes phylogenetic diversity of features within a specific budget; and more. For our analysis we will use the minimum set objective, which minimizes the cost of our reserve system, while meeting our conservation targets that we specify: `add_min_set_objective()`

The conservation targets are the minimum proportion of our conservation features’ distribution that needs to be protected and included in the prioritization (or reserve design). These targets can be thought of as a quantitative interpretation of our conservation goal, and thus should be set at the amount required to ensure the long-term persistence of our focal species, habitat, or population. For this example, we will use a uniform conservation target of 20%  across all features, so we are saying the reserve system must include at least 20% of each species distribution and at least 20% of each critical habitat: `add_relative_targets(0.2)`

Now that we have decided those two things, we can construct the conservaiton problem:

```{r}
# define the problem using the cost, conservation features, objective, and targets
prob_1 <- problem(fishing_cost, feature_stack) %>% 
  add_min_set_objective() %>% 
  add_relative_targets(0.1) %>% 
  add_gurobi_solver(gap = 0.01, time_limit = 2100)

# print problem
print(prob_1)
```

## Step 5. Solve the problem 
To solve the problem, we will run *prioritizr* using a solver or optimization software. The recommended and most common one used is Gurobi, which has special licenses available to academics at no cost. If you have not already downloaded this, please see the README.md for instructions. 
```{r}
# solve the problem
sprob_1 <- solve(prob_1)

# plot the solution to see what it looks like
plot(sprob_1,  main = c("10% Targets"))
```

#----------------------------#
# Variations to the Analysis 
#----------------------------#

Now that you've defined your baseline problem, you can adjust your model with different variations. Here, we'll walk through a few of those variables you can add. 

## Changing Targets 
```{r}

# Let's change our prob_1 target to include 30% of the conservation features, instead of 10%

## Baseline -30% target
prob_area_30 <- problem(fishing_cost, features = feature_stack) %>%
  add_min_set_objective() %>%
  add_relative_targets(0.3)

## Solve problem
sprob_area_30 <- solve(prob_area_30)

## Plot the solution to see what it looks like
plot(sprob_area_30,  main = c("Area- 30% Targets"))

## Save as tif
# writeRaster(sprob_area_30, here("final_results", "scenario_1_area",  "sprob_area_30_6hr_blm0.tif"), overwrite = TRUE)
```

## Locking-in/Locking-out
```{r}
# Here, we lock-in existing Marine Protected Areas

### read in existing mpas raster
exist_mpas <- raster(here("cleaned_data", "mpa_rast.tif"))

#exist_mpas <- setExtent(exist_mpas, ext=extent(mz_eez_rast), keepres=FALSE, snap=FALSE)                     

### plot to make sure it looks okay
plot(exist_mpas)

## Run model with locked-in constraints: 
prob_area_30 <- problem(fishing_cost, features = feature_stack) %>%
  add_min_set_objective() %>%
  add_relative_targets(0.3) %>%
  add_locked_in_constraints(exist_mpas)

## Solve problem
sprob_area_30 <- solve(prob_area_30)

## Plot the solution to see what it looks like
plot(sprob_area_30,  main = c("Area- 30% Targets with MPAs locked-in"))

```

### Setting some global model parameters
```{r}

# Here, we'll be setting: 
# -the gap (want the gap to be as small as possible) 
# -time limit (how long your model will run)
# -efficient boundary penalty (optimal penatly to reduce fragementation within your reserves)

## If you decide to change the gap, time-limit or boundary penalty value, change it here and rerun the subsequent model runs

gap <- 0.01
time_limit <- 120
bp <- 0.000001

# Run the model with all of the new model parameters:
prob_area_30 <- problem(fishing_cost, features = feature_stack) %>%
  add_min_set_objective() %>%
  add_relative_targets(0.3) %>%
  add_locked_in_constraints(exist_mpas) %>%
  add_gurobi_solver(gap = gap, time_limit = time_limit) %>% 
  add_boundary_penalties(bp)

## Solve problem
sprob_area_30 <- solve(prob_area_30)

## Plot the solution to see what it looks like
plot(sprob_area_30,  main = c("Area- 30% Targets with MPAs locked-in with BP"))

```


## Different Conservation Problems
#Irreplaceability:
Now let’s explore which planning units selected in the prioritization are most important for meeting our targets as cost-effectively as possible. To achieve this, we will calculate importance (irreplaceability) scores using a version of the replacement cost method. Under this method, planning units with higher scores are more important for meeting the objective of our conservation planning problem than those with lower scores. Furthermore, planning units with infinite scores are irreplaceable—it is impossible to meet our targets without protecting these planning units. Note that we override the solver behavior in the code below to prevent lots of unnecessary text from being output.

#For Contiguity use add_contiguity_constraints
This solution is even better then the previous solution. However, we are not finished yet. This solution does not maintain connectivity between reserves, and so species may have limited capacity to disperse throughout the solution. To avoid this, we can add contiguity constraints (add_contiguity_constraints)









